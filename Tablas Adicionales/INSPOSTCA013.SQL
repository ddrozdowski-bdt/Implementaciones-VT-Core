create or replace PROCEDURE      INSUDB.INSPOSTCA013
/*-------------------------------------------------------------------------------------*/
/* NOMBRE    : INSPOSTCA013                                                            */
/* OBJETIVO  : ACTUALIZA LOS MODULOS ASOCIADOS A LA POLIZA/CERTIFICADO                 */
/* PARAMETROS:  1 - SCERTYPE    : TIPO DE REGISTRO                                     */
/*              2 - NBRANCH     : CODIGO DEL RAMO                                      */
/*              3 - NPRODUCT    : CODIGO DEL PRODUCTO                                  */
/*              4 - NPOLICY     : NUMERO DE POLIZA                                     */
/*              5 - NCERTIF     : NUMERO DE CERTIFICADO                                */
/*              6 - NGROUP_INSU : CODIGO DEL GRUPO ASEGURADO                           */
/*              7 - NMODULEC    : CODIGO DEL MODULO                                    */
/*              8 - DEFFECDATE  : FECHA DE EFECTO DE LA TRANSACCION                    */
/*              9 - DNULLDATE   : FECHA DE ANULACION                                   */
/*             10 - NUSERCODE   : CODIGO DEL USUARIO                                   */
/*             11 - SCHANGEI    : INDICADOR DE QUE PERMITE CAMBIOS                     */
/*             12 - NCURRENCY   : CODIGO DE LA MONEDA                                  */
/*             13 - SPOLITYPE   : TIPO DE POLIZA                                       */
/*             14 - STYP_MODULE : INDICA COMO ESTAN REGISTRADOS LOS MODULOS            */
/*             15 - SBRANCHT    : CODIGO DEL RAMO TECNICO DEL PRODUCTO                 */
/*             16 - NACTION     : INDICA LA ACCION A EJECUTAR SOBRE LA TABLA           */
/*             17 - NTRANSACTION: TRANSACCION REALIZADA SOBRE LA POLIZA                */
/*                                                                                     */
/* SOURCESAFE INFORMATION                                                              */
/*     $Author: Gazuaje $*/
/*     $Date: 27-09-09 19:48 $*/
/*     $Revision: 2 $*/
/*-------------------------------------------------------------------------------------*/
    (SCERTYPE     MODULES.SCERTYPE%TYPE,
     NBRANCH      MODULES.NBRANCH%TYPE,
     NPRODUCT     MODULES.NPRODUCT%TYPE,
     NPOLICY      MODULES.NPOLICY%TYPE,
     NCERTIF      MODULES.NCERTIF%TYPE,
     NGROUP_INSU  MODULES.NGROUP_INSU%TYPE,
     NMODULEC     MODULES.NMODULEC%TYPE,
     DEFFECDATE   MODULES.DEFFECDATE%TYPE,
     DNULLDATE    MODULES.DNULLDATE%TYPE,
     NUSERCODE    MODULES.NUSERCODE%TYPE,
     SCHANGEI     MODULES.SCHANGEI%TYPE,
     NCURRENCY    MODULES.NCURRENCY%TYPE,
     SPOLITYPE    POLICY.SPOLITYPE%TYPE,
     STYP_MODULE  POLICY.STYP_MODULE%TYPE,
     SBRANCHT     PRODMASTER.SBRANCHT%TYPE,
     NACTION      IN OUT INTEGER,
     NTRANSACTION TABLE221.NCODIGINT%TYPE DEFAULT 1,
     NPREMIRAT    MODULES.NPREMIRAT%TYPE,
     STYP_RAT     MODULES.STYP_RAT%TYPE,
     NCOMMIT      SMALLINT DEFAULT 1,
     SINHERIT     MODULES.SINHERIT%TYPE DEFAULT '2') AUTHID CURRENT_USER AS

     NEXISTS      INTEGER;

     SCONTEN     VARCHAR2(1);
     C_PRODUCT   REAPRODUCTGENERALPKG.RCT1;
     R_PRODUCT   REAPRODUCTGENERALPKG.RT1;
     SWINDOWS    VARCHAR(100);

    NCUENTA NUMBER;
    NTYPE_AMEND NUMBER;
    NCAUSE_AMEND NUMBER;
    
BEGIN
    SELECT NTYPE_AMEND ,NCAUSE_AMEND 
    INTO NTYPE_AMEND,NCAUSE_AMEND 
    FROM POLICY_HIS
    WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
    AND NBRANCH = INSPOSTCA013.NBRANCH
    AND NPRODUCT = INSPOSTCA013.NPRODUCT
    AND NPOLICY  = INSPOSTCA013.NPOLICY
    AND NCERTIF  = INSPOSTCA013.NCERTIF
    AND NTRANSACTIO=
    (SELECT MAX(NTRANSACTIO)
    FROM POLICY_HIS HISTORIA
    WHERE POLICY_HIS.SCERTYPE = HISTORIA.SCERTYPE
    AND POLICY_HIS.NBRANCH = HISTORIA.NBRANCH
    AND POLICY_HIS.NPRODUCT = HISTORIA.NPRODUCT
    AND POLICY_HIS.NPOLICY  = HISTORIA.NPOLICY
    AND POLICY_HIS.NCERTIF  = HISTORIA.NCERTIF);
	
	-- BDT-05/01/2024-Proceso para endosos retroactivos
    
    IF NTYPE_AMEND=2 AND NCAUSE_AMEND=3 THEN
        SELECT COUNT(0) INTO NCUENTA 
        FROM MODULES
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >  INSPOSTCA013.DEFFECDATE
        AND DNULLDATE IS NULL; 
    ELSE
        NCUENTA :=0;
    END IF;
    
    IF NCUENTA<>0 AND NTYPE_AMEND=2 AND NCAUSE_AMEND=3 THEN
        INSERT INTO CLAUSE_HIS
        SELECT CLAUSE.*,INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM CLAUSE_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM CLAUSE                             
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;
        
        DELETE CLAUSE 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;
       
        UPDATE CLAUSE 
        SET DNULLDATE = NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE = INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    = INSPOSTCA013.SCERTYPE
        AND NBRANCH     = INSPOSTCA013.NBRANCH
        AND NPRODUCT    = INSPOSTCA013.NPRODUCT
        AND NPOLICY     = INSPOSTCA013.NPOLICY
        AND NCERTIF     = INSPOSTCA013.NCERTIF
        AND NGROUP_INSU = INSPOSTCA013.NGROUP_INSU
        AND NMODULEC = INSPOSTCA013.NMODULEC
        and DEFFECDATE=
        (SELECT MAX(CLAUSE_HIS.DEFFECDATE) 
        FROM CLAUSE CLAUSE_HIS
        WHERE CLAUSE_HIS.SCERTYPE= CLAUSE.SCERTYPE
        AND CLAUSE_HIS.NBRANCH= CLAUSE.NBRANCH
        AND CLAUSE_HIS.NPRODUCT= CLAUSE.NPRODUCT
        AND CLAUSE_HIS.NPOLICY= CLAUSE.NPOLICY
        AND CLAUSE_HIS.NCERTIF= CLAUSE.NCERTIF
        AND CLAUSE_HIS.NMODULEC= CLAUSE.NMODULEC
        AND CLAUSE_HIS.NCOVER= CLAUSE.NCOVER
        AND CLAUSE_HIS.NCLAUSE= CLAUSE.NCLAUSE
        AND CLAUSE_HIS.DEFFECDATE< INSPOSTCA013.DEFFECDATE);

        INSERT INTO COVER_HIS
        SELECT COVER.*,INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM COVER_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM COVER                             
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;
        
        DELETE COVER 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;

        UPDATE COVER 
        SET DNULLDATE = NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE = INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    = INSPOSTCA013.SCERTYPE
        AND NBRANCH     = INSPOSTCA013.NBRANCH
        AND NPRODUCT    = INSPOSTCA013.NPRODUCT
        AND NPOLICY     = INSPOSTCA013.NPOLICY
        AND NCERTIF     = INSPOSTCA013.NCERTIF
        AND NGROUP_INSU = INSPOSTCA013.NGROUP_INSU
        AND NMODULEC = INSPOSTCA013.NMODULEC
        and DEFFECDATE=
        (SELECT MAX(COVER_HIS.DEFFECDATE) 
        FROM COVER COVER_HIS
        WHERE COVER_HIS.SCERTYPE= COVER.SCERTYPE
        AND COVER_HIS.NBRANCH= COVER.NBRANCH
        AND COVER_HIS.NPRODUCT= COVER.NPRODUCT
        AND COVER_HIS.NPOLICY= COVER.NPOLICY
        AND COVER_HIS.NCERTIF= COVER.NCERTIF
        AND COVER_HIS.NMODULEC= COVER.NMODULEC
        AND COVER_HIS.NCOVER= COVER.NCOVER
        AND COVER_HIS.DEFFECDATE< INSPOSTCA013.DEFFECDATE);

        INSERT INTO MODULES_HIS
        SELECT MODULES.*, INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM MODULES_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM MODULES                            
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;

        DELETE MODULES 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;

        UPDATE MODULES 
        SET DNULLDATE =  NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE =  INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    =  INSPOSTCA013.SCERTYPE
        AND NBRANCH     =  INSPOSTCA013.NBRANCH
        AND NPRODUCT    =  INSPOSTCA013.NPRODUCT
        AND NPOLICY     =  INSPOSTCA013.NPOLICY
        AND NCERTIF     =  INSPOSTCA013.NCERTIF
        AND NGROUP_INSU =  INSPOSTCA013.NGROUP_INSU
        AND NMODULEC = INSPOSTCA013.NMODULEC
        and DEFFECDATE=
        (SELECT MAX(MODULES.DEFFECDATE) 
        FROM MODULES MODULES_HIS
        WHERE MODULES_HIS.SCERTYPE= MODULES.SCERTYPE
        AND MODULES_HIS.NBRANCH= MODULES.NBRANCH
        AND MODULES_HIS.NPRODUCT= MODULES.NPRODUCT
        AND MODULES_HIS.NPOLICY= MODULES.NPOLICY
        AND MODULES_HIS.NCERTIF= MODULES.NCERTIF
        AND MODULES_HIS.NMODULEC= MODULES.NMODULEC
        AND MODULES_HIS.DEFFECDATE<  INSPOSTCA013.DEFFECDATE);
        
        INSERT INTO THEFT_HIS
        SELECT THEFT.*,INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM THEFT_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM THEFT                             
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;
        
        DELETE THEFT 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;

        UPDATE THEFT 
        SET DNULLDATE = NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE = INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    = INSPOSTCA013.SCERTYPE
        AND NBRANCH     = INSPOSTCA013.NBRANCH
        AND NPRODUCT    = INSPOSTCA013.NPRODUCT
        AND NPOLICY     = INSPOSTCA013.NPOLICY
        AND NCERTIF     = INSPOSTCA013.NCERTIF
        and DEFFECDATE=
        (SELECT MAX(THEFT_HIS.DEFFECDATE) 
        FROM THEFT THEFT_HIS
        WHERE THEFT_HIS.SCERTYPE= THEFT.SCERTYPE
        AND THEFT_HIS.NBRANCH= THEFT.NBRANCH
        AND THEFT_HIS.NPRODUCT= THEFT.NPRODUCT
        AND THEFT_HIS.NPOLICY= THEFT.NPOLICY
        AND THEFT_HIS.NCERTIF= THEFT.NCERTIF
        AND THEFT_HIS.DEFFECDATE< INSPOSTCA013.DEFFECDATE);
        
        INSERT INTO HOMEOWNER_HIS
        SELECT HOMEOWNER.*,INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM HOMEOWNER_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM HOMEOWNER                             
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;
        
        DELETE HOMEOWNER 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;

        UPDATE HOMEOWNER 
        SET DNULLDATE = NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE = INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    = INSPOSTCA013.SCERTYPE
        AND NBRANCH     = INSPOSTCA013.NBRANCH
        AND NPRODUCT    = INSPOSTCA013.NPRODUCT
        AND NPOLICY     = INSPOSTCA013.NPOLICY
        AND NCERTIF     = INSPOSTCA013.NCERTIF
        and DEFFECDATE=
        (SELECT MAX(HOMEOWNER_HIS.DEFFECDATE) 
        FROM HOMEOWNER HOMEOWNER_HIS
        WHERE HOMEOWNER_HIS.SCERTYPE= HOMEOWNER.SCERTYPE
        AND HOMEOWNER_HIS.NBRANCH= HOMEOWNER.NBRANCH
        AND HOMEOWNER_HIS.NPRODUCT= HOMEOWNER.NPRODUCT
        AND HOMEOWNER_HIS.NPOLICY= HOMEOWNER.NPOLICY
        AND HOMEOWNER_HIS.NCERTIF= HOMEOWNER.NCERTIF
        AND HOMEOWNER_HIS.DEFFECDATE< INSPOSTCA013.DEFFECDATE);

        INSERT INTO MULTI_RISK_HIS
        SELECT MULTI_RISK.*,INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM MULTI_RISK_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM MULTI_RISK                             
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;
        
        DELETE MULTI_RISK 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;

        UPDATE MULTI_RISK 
        SET DNULLDATE = NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE = INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    = INSPOSTCA013.SCERTYPE
        AND NBRANCH     = INSPOSTCA013.NBRANCH
        AND NPRODUCT    = INSPOSTCA013.NPRODUCT
        AND NPOLICY     = INSPOSTCA013.NPOLICY
        AND NCERTIF     = INSPOSTCA013.NCERTIF
        and DEFFECDATE=
        (SELECT MAX(MULTI_RISK_HIS.DEFFECDATE) 
        FROM MULTI_RISK MULTI_RISK_HIS
        WHERE MULTI_RISK_HIS.SCERTYPE= MULTI_RISK.SCERTYPE
        AND MULTI_RISK_HIS.NBRANCH= MULTI_RISK.NBRANCH
        AND MULTI_RISK_HIS.NPRODUCT= MULTI_RISK.NPRODUCT
        AND MULTI_RISK_HIS.NPOLICY= MULTI_RISK.NPOLICY
        AND MULTI_RISK_HIS.NCERTIF= MULTI_RISK.NCERTIF
        AND MULTI_RISK_HIS.DEFFECDATE< INSPOSTCA013.DEFFECDATE);
        
        INSERT INTO LIFE_HIS
        SELECT LIFE.*,INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM LIFE_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM LIFE                             
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;
        
        DELETE LIFE 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;

        UPDATE LIFE 
        SET DNULLDATE = NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE = INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    = INSPOSTCA013.SCERTYPE
        AND NBRANCH     = INSPOSTCA013.NBRANCH
        AND NPRODUCT    = INSPOSTCA013.NPRODUCT
        AND NPOLICY     = INSPOSTCA013.NPOLICY
        AND NCERTIF     = INSPOSTCA013.NCERTIF
        and DEFFECDATE=
        (SELECT MAX(LIFE_HIS.DEFFECDATE) 
        FROM LIFE LIFE_HIS
        WHERE LIFE_HIS.SCERTYPE= LIFE.SCERTYPE
        AND LIFE_HIS.NBRANCH= LIFE.NBRANCH
        AND LIFE_HIS.NPRODUCT= LIFE.NPRODUCT
        AND LIFE_HIS.NPOLICY= LIFE.NPOLICY
        AND LIFE_HIS.NCERTIF= LIFE.NCERTIF
        AND LIFE_HIS.DEFFECDATE< INSPOSTCA013.DEFFECDATE);
        
        INSERT INTO EQUIPMENT_HIS
        SELECT EQUIPMENT.*,INSPOSTCA013.NUSERCODE,SYSTIMESTAMP,
        (SELECT NVL(((SELECT MAX(NTRANSACTIO_HIS) FROM EQUIPMENT_HIS)),0) FROM DUAL) + ROWNUM ,
        'INSPOSTCA013','DEL'
        FROM EQUIPMENT                             
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE >= INSPOSTCA013.DEFFECDATE;
        
        DELETE EQUIPMENT 
        WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
        AND NBRANCH = INSPOSTCA013.NBRANCH
        AND NPRODUCT = INSPOSTCA013.NPRODUCT
        AND NPOLICY  = INSPOSTCA013.NPOLICY
        AND NCERTIF  = INSPOSTCA013.NCERTIF
        AND DEFFECDATE > INSPOSTCA013.DEFFECDATE;

        UPDATE EQUIPMENT 
        SET DNULLDATE = NULL,
        DCOMPDATE = SYSDATE,
        NUSERCODE = INSPOSTCA013.NUSERCODE
        WHERE SCERTYPE    = INSPOSTCA013.SCERTYPE
        AND NBRANCH     = INSPOSTCA013.NBRANCH
        AND NPRODUCT    = INSPOSTCA013.NPRODUCT
        AND NPOLICY     = INSPOSTCA013.NPOLICY
        AND NCERTIF     = INSPOSTCA013.NCERTIF
        and DEFFECDATE=
        (SELECT MAX(EQUIPMENT_HIS.DEFFECDATE) 
        FROM EQUIPMENT EQUIPMENT_HIS
        WHERE EQUIPMENT_HIS.SCERTYPE= EQUIPMENT.SCERTYPE
        AND EQUIPMENT_HIS.NBRANCH= EQUIPMENT.NBRANCH
        AND EQUIPMENT_HIS.NPRODUCT= EQUIPMENT.NPRODUCT
        AND EQUIPMENT_HIS.NPOLICY= EQUIPMENT.NPOLICY
        AND EQUIPMENT_HIS.NCERTIF= EQUIPMENT.NCERTIF
        AND EQUIPMENT_HIS.DEFFECDATE< INSPOSTCA013.DEFFECDATE);
    END IF;    
    
    REAPRODUCTGENERAL(NBRANCH    => NBRANCH,
                      NPRODUCT   => NPRODUCT,
                      DEFFECDATE => DEFFECDATE,
                      RC1        => C_PRODUCT);

    FETCH C_PRODUCT
     INTO R_PRODUCT;

    IF R_PRODUCT.SBRANCHT <> '1' THEN
        IF NTRANSACTION  = 26 THEN
            SCONTEN := '3';
            SWINDOWS := SWINDOWS || 'CA027A|' || SCONTEN || ';';

            INSUPDPOLICY_WIN_ARR(SCERTYPE   => SCERTYPE,
                                 NBRANCH    => NBRANCH,
                                 NPRODUCT   => NPRODUCT,
                                 NPOLICY    => NPOLICY,
                                 NCERTIF    => NCERTIF,
                                 DEFFECDATE => DEFFECDATE,
                                 SWINDOW    => SWINDOWS,
                                 NUSERCODE  => NUSERCODE);

        END IF;
    END IF;

    SWINDOWS := '';
/*+SI EL TIPO DE POLIZA ES INDIVIDUAL O ES UN CERTIFICADO*/
    IF SPOLITYPE = '1' OR
       NCERTIF   > 0   THEN

    
        INSUPDMODULES(SCERTYPE     => SCERTYPE,
                      NBRANCH      => NBRANCH,
                      NPRODUCT     => NPRODUCT,
                      NPOLICY      => NPOLICY,
                      NCERTIF      => NCERTIF,
                      NGROUP_INSU  => NGROUP_INSU,
                      NMODULEC     => NMODULEC,
                      DEFFECDATE   => DEFFECDATE,
                      DNULLDATE    => DNULLDATE,
                      NUSERCODE    => NUSERCODE,
                      SCHANGEI     => SCHANGEI,
                      NCURRENCY    => NCURRENCY,
                      NACTION      => NACTION,
                      NTRANSACTION => NTRANSACTION,
                      NPREMIRAT    => NPREMIRAT,
                      STYP_RAT     => STYP_RAT,
                      NCOMMIT      => 2,
                      SINHERIT     => SINHERIT);

    ELSE
/*+SI LOS MODULOS SON POR POLIZA*/
        IF STYP_MODULE = '2' THEN
            INSUPDMODUL_CO_P(SCERTYPE     => SCERTYPE,
                             NBRANCH      => NBRANCH,
                             NPRODUCT     => NPRODUCT,
                             NPOLICY      => NPOLICY,
                             NMODULEC     => NMODULEC,
                             DEFFECDATE   => DEFFECDATE,
                             DNULLDATE    => DNULLDATE,
                             NUSERCODE    => NUSERCODE,
                             NACTION      => NACTION,
                             NTRANSACTION => NTRANSACTION,
                             NPREMIRAT    => NPREMIRAT,
                             STYP_RAT     => STYP_RAT,
                             NCOMMIT      => 2);

/*+SI LOS MODULOS SON POR GRUPO*/
        ELSIF STYP_MODULE = '3' THEN
            INSUPDMODUL_CO_G(SCERTYPE     => SCERTYPE,
                             NBRANCH      => NBRANCH,
                             NPRODUCT     => NPRODUCT,
                             NPOLICY      => NPOLICY,
                             NMODULEC     => NMODULEC,
                             NGROUP       => NGROUP_INSU,
                             DEFFECDATE   => DEFFECDATE,
                             DNULLDATE    => DNULLDATE,
                             NUSERCODE    => NUSERCODE,
                             NACTION      => NACTION,
                             NTRANSACTION => NTRANSACTION,
                             NPREMIRAT    => NPREMIRAT,
                             STYP_RAT     => STYP_RAT,
                             NCOMMIT      => 2);
        END IF;
    END IF;

    IF NACTION = 3 THEN
        INSDELCOVER_IN_MODULE(SCERTYPE     => SCERTYPE,
                              NBRANCH      => NBRANCH,
                              NPRODUCT     => NPRODUCT,
                              NPOLICY      => NPOLICY,
                              NCERTIF      => NCERTIF,
                              DEFFECDATE   => DEFFECDATE,
                              NMODULEC     => NMODULEC,
                              DNULLDATE    => DNULLDATE,
                              SPOLITYPE    => SPOLITYPE,
                              STYP_MODULE  => STYP_MODULE,
                              NUSERCODE    => NUSERCODE,
                              NTRANSACTION => NTRANSACTION,
                              SBRANCHT     => SBRANCHT,
                              NGROUP       => NGROUP_INSU);

        BEGIN
            SELECT COUNT(1)
              INTO NEXISTS
              FROM MODULES
             WHERE SCERTYPE = INSPOSTCA013.SCERTYPE
               AND NBRANCH  = INSPOSTCA013.NBRANCH
               AND NPRODUCT = INSPOSTCA013.NPRODUCT
               AND NPOLICY  = INSPOSTCA013.NPOLICY
               AND NCERTIF  = INSPOSTCA013.NCERTIF
               AND DEFFECDATE <= INSPOSTCA013.DEFFECDATE
               AND (DNULLDATE IS NULL
                OR  DNULLDATE  > INSPOSTCA013.DEFFECDATE);
        EXCEPTION
            WHEN OTHERS THEN
                NEXISTS := 0;
        END;

        IF NVL(NEXISTS,0) = 0 THEN
            INSUPDPOLICY_WIN(SCERTYPE   => SCERTYPE,
                             NBRANCH    => NBRANCH,
                             NPRODUCT   => NPRODUCT,
                             NPOLICY    => NPOLICY,
                             NCERTIF    => NCERTIF,
                             DEFFECDATE => DEFFECDATE,
                             SCODISPL   => 'CA013',
                             NUSERCODE  => NUSERCODE,
                             SCONTEN    => '3',
                             NCOMMIT    => 2);
        END IF;

    END IF;
    IF NCOMMIT = 1 THEN
        COMMIT;
    END IF;

END INSPOSTCA013;